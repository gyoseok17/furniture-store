<div id="wrapper" th:fragment="content">
    <div class="container mt-5">
        <h2 class="text-center">일반 회원 가입</h2>

        <!-- 회원 가입 성공 메시지 -->
        <div th:if="${message}" class="alert alert-success">
            <span th:text="${message}"></span>
        </div>
        <form th:action="@{/user/userRegister}" method="post" th:object="${user}" onsubmit="return validateForm()">
            <div class="mb-3">
                <label for="userId" class="form-label">아이디</label>
                <div class="input-group">
                    <input type="text" id="userId" class="form-control" th:field="*{userId}" required>
                    <button type="button" class="btn btn-secondary" onclick="checkUserId()">중복 확인</button>
                </div>
                <small id="checkResult" class="text-muted"></small>
            </div>

            <div class="mb-3">
                <label for="password" class="form-label">비밀번호</label>
                <input type="password" id="password" name="pwd" class="form-control" th:field="*{pwd}" required>
            </div>

            <div class="mb-3">
                <label for="userNm" class="form-label">이름</label>
                <input type="text" id="userNm" name="userNm" class="form-control" th:field="*{userNm}" required>
            </div>

            <div class="mb-3">
                <label for="email" class="form-label">이메일</label>
                <input type="email" id="email" name="email" class="form-control" th:field="*{email}" required>
            </div>

            <div class="form-group">
                <label for="postcode">주소</label>
                <div class="input-group">
                    <input type="text" id="postcode" name="postcode" class="form-control" placeholder="우편번호" readonly>
                    <button type="button" class="btn btn-outline-secondary" onclick="execDaumPostcode()">주소 찾기</button>
                </div>
            </div>
            <div class="form-group">
                <input type="text" id="address" name="address" class="form-control" placeholder="기본주소" readonly>
            </div>
            <div class="form-group">
                <input type="text" id="detailAddress" name="detailAddress" class="form-control" placeholder="상세주소">
            </div>

            <button type="submit" class="btn btn-primary w-100">회원 가입</button>
        </form>

        <div class="mt-3 text-center">
            <a href="/user/login">로그인</a>
        </div>
    </div>
    <script>

    </script>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script>
        function execDaumPostcode() {//주소찾기
            new daum.Postcode({
                oncomplete: function(data) {
                    document.getElementById("postcode").value = data.zonecode;
                    document.getElementById("address").value = data.address;
                    document.getElementById("detailAddress").focus();
                }
            }).open();
        }
    </script>
    <script>
        let isUserIdChecked = false;
        
        function checkUserId() {
            const userId = document.getElementById("userId").value.trim();
        
            if (userId === "") {
                document.getElementById("checkResult").innerHTML = "<span class='text-danger'>아이디를 입력하세요.</span>";
                isUserIdChecked = false;
                return;
            }
        
            fetch(`/user/checkUserId?userId=${encodeURIComponent(userId)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("서버 오류");
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.exists) {
                        document.getElementById("checkResult").innerHTML = "<span class='text-danger'>이미 존재하는 아이디입니다.</span>";
                        isUserIdChecked = false;
                    } else {
                        document.getElementById("checkResult").innerHTML = "<span class='text-success'>사용 가능한 아이디입니다.</span>";
                        isUserIdChecked = true;
                    }
                })
                .catch(error => {
                    document.getElementById("checkResult").innerHTML = "<span class='text-danger'>중복 확인 중 오류가 발생했습니다.</span>";
                    isUserIdChecked = false;
                });
        }

        // 아이디 입력 시 검사 다시 하도록 처리
        document.addEventListener("DOMContentLoaded", function () {
            const userIdInput = document.getElementById("userId");
            if (userIdInput) {
                userIdInput.addEventListener("input", function () {
                    isUserIdChecked = false;
                    document.getElementById("checkResult").innerHTML = "";
                });
            }
        });

        function validateForm() {
            if (!isUserIdChecked) {
                alert("아이디 중복 검사를 해주세요.");
                return false; // 🚫 제출 차단
            }
            return true; // ✅ 통과 시 제출
        }
    </script>
</div>
