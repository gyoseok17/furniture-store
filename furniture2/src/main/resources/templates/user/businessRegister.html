<div id="wrapper" th:fragment="content">
    <div class="container mt-5">
        <h2 class="text-center">ê¸°ì—… íšŒì› ê°€ì…</h2>

        <!-- íšŒì› ê°€ì… ì„±ê³µ ë©”ì‹œì§€ -->
        <div th:if="${message}" class="alert alert-success">
            <span th:text="${message}"></span>
        </div>
        <form th:action="@{/user/businessRegister}" method="post" th:object="${userBusinessForm}" onsubmit="return validateForm()">
            <div class="mb-3">
                <label for="businessName" class="form-label">ì‚¬ì—…ì ìƒí˜¸ëª…</label>
                <input type="text" class="form-control" th:field="*{businessForm.businessName}" required>
            </div>

            <div class="mb-3">
                <label for="businessNumber" class="form-label">ì‚¬ì—…ì ë“±ë¡ë²ˆí˜¸</label>
                <input type="text" class="form-control" th:field="*{businessForm.businessNumber}"
                       maxlength="12" required oninput="formatBusinessNumber(this)">
            </div>

            <div class="mb-3">
                <label for="userId" class="form-label">ì•„ì´ë””</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="userId" th:field="*{userForm.userId}" required>
                    <button type="button" class="btn btn-secondary" onclick="checkUserId()">ì¤‘ë³µ í™•ì¸</button>
                </div>
                <small id="checkResult" class="text-muted"></small>
            </div>

            <div class="mb-3">
                <label for="password" class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" class="form-control" th:field="*{userForm.pwd}" required>
            </div>

            <div class="mb-3">
                <label for="userNm" class="form-label">ì´ë¦„</label>
                <input type="text" class="form-control" th:field="*{userForm.userNm}" required>
            </div>

            <div class="mb-3">
                <label for="email" class="form-label">ì´ë©”ì¼</label>
                <input type="email" class="form-control" th:field="*{userForm.email}" required>
            </div>

            <div class="mb-3">
                <label for="zipcode" class="form-label">ìš°í¸ë²ˆí˜¸</label>
                <div class="input-group">
                    <input type="text" class="form-control" th:field="*{userForm.zipcode}" readonly>
                    <button type="button" class="btn btn-outline-secondary" onclick="execDaumPostcode()">ì£¼ì†Œ ì°¾ê¸°</button>
                </div>
            </div>
            
            <div class="mb-3">
                <label for="address" class="form-label">ê¸°ë³¸ ì£¼ì†Œ</label>
                <input type="text" class="form-control" th:field="*{userForm.address}" readonly>
            </div>
            
            <div class="mb-3">
                <label for="addressDetail" class="form-label">ìƒì„¸ ì£¼ì†Œ</label>
                <input type="text" class="form-control" th:field="*{userForm.addressDetail}">
            </div>

            <button type="submit" class="btn btn-primary w-100">íšŒì› ê°€ì…</button>
        </form>

        <div class="mt-3 text-center">
            <a href="/user/login">ë¡œê·¸ì¸</a>
        </div>
    </div>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script> 
    <script> //ì£¼ì†Œ ê²€ìƒ‰
        function execDaumPostcode() {
            new daum.Postcode({
                oncomplete: function(data) {
                    document.getElementById("zipcode").value = data.zonecode;
                    document.getElementById("address").value = data.address;
                    document.getElementById("addressDetail").focus();
                }
            }).open();
        }
    </script>
    <script> //ì‚¬ì—…ì ë²ˆí˜¸ ì…ë ¥
        function formatBusinessNumber(input) {
            let value = input.value.replace(/[^0-9]/g, ""); // ìˆ«ìë§Œ ë‚¨ê¸°ê¸°
            if (value.length > 3 && value.length <= 5) {
                value = value.slice(0, 3) + "-" + value.slice(3);
            } else if (value.length > 5) {
                value = value.slice(0, 3) + "-" + value.slice(3, 5) + "-" + value.slice(5, 10);
            }
            input.value = value;
        }
    </script>
    <script>
        let isUserIdChecked = false;
        
        function checkUserId() {
            const userId = document.getElementById("userId").value.trim();
        
            if (userId === "") {
                document.getElementById("checkResult").innerHTML = "<span class='text-danger'>ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</span>";
                isUserIdChecked = false;
                return;
            }
        
            fetch(`/user/checkUserId?userId=${encodeURIComponent(userId)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("ì„œë²„ ì˜¤ë¥˜");
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.exists) {
                        document.getElementById("checkResult").innerHTML = "<span class='text-danger'>ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.</span>";
                        isUserIdChecked = false;
                    } else {
                        document.getElementById("checkResult").innerHTML = "<span class='text-success'>ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤.</span>";
                        isUserIdChecked = true;
                    }
                })
                .catch(error => {
                    document.getElementById("checkResult").innerHTML = "<span class='text-danger'>ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</span>";
                    isUserIdChecked = false;
                });
        }
        // ì•„ì´ë”” ì…ë ¥ ì‹œ ê²€ì‚¬ ë‹¤ì‹œ í•˜ë„ë¡ ì²˜ë¦¬
        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("userId").addEventListener("input", function () {
                isUserIdChecked = false;
                document.getElementById("checkResult").innerHTML = "";
            });
        });
        function validateForm() {
            if (!isUserIdChecked) {
                alert("ì•„ì´ë”” ì¤‘ë³µ ê²€ì‚¬ë¥¼ í•´ì£¼ì„¸ìš”.");
                return false; // ğŸš« ì œì¶œ ì°¨ë‹¨
            }
            return true; // âœ… í†µê³¼ ì‹œ ì œì¶œ
        }
    </script>
</div>
