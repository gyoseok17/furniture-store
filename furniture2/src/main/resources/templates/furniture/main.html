<div id="wrapper" th:fragment="content">
    <style>
        .product-img {
            height: 200px;
            object-fit: cover;
        }

        /* 배너 고정 크기 */
        .carousel-item img {
            width: 100%;
            height: 600px;
            object-fit: cover;
        }

        /* 상품 카드 이미지 고정 크기 */
        .product-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        /* 카드 전체 높이 맞춤 */
        .card {
            height: 320px;
        }

        .card-body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 120px;
        }
    </style>
    <div id="mainCarousel" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-inner">
            <div class="carousel-item active">
                <img src="https://ems.elancer.co.kr/99_upload/Append/T_Blog/editor/2023100609495830406.jpg" class="d-block w-100" alt="배너1">
            </div>
<!--            <div class="carousel-item">-->
<!--                <img src="https://via.placeholder.com/1200x400?text=배너+2" class="d-block w-100" alt="배너2">-->
<!--            </div>-->
<!--            <div class="carousel-item">-->
<!--                <img src="https://via.placeholder.com/1200x400?text=배너+3" class="d-block w-100" alt="배너3">-->
<!--            </div>-->
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#mainCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon"></span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#mainCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon"></span>
        </button>
    </div>

    <!-- 상품 카드 3개 -->
    <div class="container mt-5">
        <div class="row text-center" >
            <div class="col-md-4" th:each="product : ${products}">
                <div class="card" th:attr="data-id=${product.id}" ondblclick="handleCardDbclick(this)">
                    <img th:src="${product.imageUrl}" th:alt="${product.modelName}">
                    <div class="info">
                        <h3 style="font-weight: bold;" th:text="${product.modelName}">모델명</h3>
                        <p th:text="${product.description}">상세설명</p>
                        <p style="font-weight: bold; font-size: 1.2em;"
                           th:text="|₩${#numbers.formatInteger(product.price, 3, 'COMMA')}|">가격</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div th:replace="~{modal/funitureDetailModal :: detailModalFragment}">
    </div>
    <script th:inline="javascript">
        const handleCardDbclick = async(data) => {
            const productId = data.getAttribute('data-id');
            await openDetailModal(productId)
        }

        //더블 클릭 시 상품 상세 모달 열기
        const openDetailModal = async(productId) => {
        const response = await fetch(`/furniture/shop/detail/${productId}`);
        if (!response.ok) {
            console.error("서버오류");
            return;
        }
        const jsonObject = await response.json()
        const detailProduct = jsonObject?.detailProduct
        
        const img = document.getElementById("productImg");
        img.src = detailProduct.imageUrl;
        img.setAttribute("data-id", detailProduct.id);

        document.getElementById("productName").innerText = detailProduct.modelName
        document.getElementById("productPrice").innerText = `₩${detailProduct.price.toLocaleString()}`
        document.getElementById("productDetailDescription").innerText = detailProduct.description
        document.getElementById("dimensionImage").src = detailProduct.dimensionImage
        document.getElementById("dimensionDetail").innerHTML = ""
        let pTag = ""
        detailProduct.dimensionsVoList.forEach(item=>{
            pTag +=`<p> ${item.keyName} : ${item.valueText} </p>`
        })
        document.getElementById("dimensionDetail").innerHTML = pTag

        console.log(detailProduct)

        // 장바구니 담기 버튼은 로그인 시에만 동작
        const isLoggedIn = /*[[${isLoggedIn}]]*/ false;
        document.getElementById("addToWishlistBtn").onclick = async () => {
            if (!isLoggedIn) {
            alert("로그인이 필요합니다.");
            return;
            }
            const productId = img.getAttribute("data-id");
            const response = await fetch('/furniture/shop/wishlist', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': csrfToken
            },
            body: JSON.stringify({
                productId: parseInt(productId),
                quantity: 1
            })
            });

            if (response.ok) {
            if (typeof reloadWishlistSidebar === 'function') {
                reloadWishlistSidebar();
            }
            alert("장바구니에 담겼습니다!");
            } else if (response.status === 401) {
            alert("로그인이 필요합니다.");
            } else {
            alert("장바구니 담기에 실패했습니다.");
            }
        };

        // 모달 표시
        const modal = new bootstrap.Modal(document.getElementById('detailModal'));
        modal.show();
        }
    </script>

</div>